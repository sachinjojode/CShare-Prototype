# ğŸ—ï¸ CShare æ¶æ§‹æ–‡æª”

## ç³»çµ±æ¶æ§‹æ¦‚è¦½

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Browser / User                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“ â†‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      HTML + CSS (View Layer)                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ index.   â”‚ login.   â”‚ modals   â”‚ forms    â”‚ grids    â”‚      â”‚
â”‚  â”‚ html     â”‚ html     â”‚          â”‚          â”‚          â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“ â†‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    src/app.js (Orchestrator)                    â”‚
â”‚                  - å”èª¿æ‰€æœ‰æ¨¡çµ„                                   â”‚
â”‚                  - è¨­ç½®äº‹ä»¶ç›£è½                                   â”‚
â”‚                  - åˆå§‹åŒ–æ‡‰ç”¨                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â†“               â†“               â†“               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Modules   â”‚  â”‚  Services   â”‚  â”‚   Stores    â”‚  â”‚     UI      â”‚
â”‚   (æ ¸å¿ƒ)    â”‚  â”‚  (æœå‹™å±¤)   â”‚  â”‚  (ç‹€æ…‹)     â”‚  â”‚   (æ¸²æŸ“)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“¦ åˆ†å±¤æ¶æ§‹ (Layered Architecture)

### ç¬¬ 1 å±¤: è¡¨ç¾å±¤ (Presentation Layer)
**ä½ç½®**: HTML/CSS æª”æ¡ˆ
**è·è²¬**: ç”¨æˆ¶ç•Œé¢çµæ§‹å’Œæ¨£å¼

```
index.html          ä¸»æ‡‰ç”¨é é¢
login.html          ç™»å…¥é é¢
styles.css          å…¨å±€æ¨£å¼
```

### ç¬¬ 2 å±¤: æ‡‰ç”¨å”èª¿å±¤ (Application Orchestration)
**ä½ç½®**: `src/app.js`
**è·è²¬**:
- åˆå§‹åŒ–æ‡‰ç”¨
- å”èª¿å„æ¨¡çµ„
- è¨­ç½®å…¨å±€äº‹ä»¶ç›£è½
- æš´éœ²å‡½æ•¸çµ¦ HTML

```javascript
// src/app.js çš„è§’è‰²
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. å°å…¥æ‰€æœ‰æ¨¡çµ„                      â”‚
â”‚  2. åˆå§‹åŒ– Firebase                   â”‚
â”‚  3. è¨­ç½®èªè­‰ç›£è½                      â”‚
â”‚  4. åˆå§‹åŒ–ç‹€æ…‹ç®¡ç†                    â”‚
â”‚  5. è¨­ç½®äº‹ä»¶ç›£è½å™¨                    â”‚
â”‚  6. æš´éœ²å¿…è¦å‡½æ•¸åˆ° window             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç¬¬ 3 å±¤: æ¥­å‹™é‚è¼¯å±¤ (Business Logic Layer)

#### 3A. æ ¸å¿ƒæ¨¡çµ„ (`src/modules/`)
```
src/modules/
â”œâ”€â”€ auth/                    èªè­‰èˆ‡æˆæ¬Š
â”‚   â””â”€â”€ authManager.js       â€¢ ç™»å…¥/ç™»å‡ºé‚è¼¯
â”‚                           â€¢ ç”¨æˆ¶ç‹€æ…‹ç®¡ç†
â”‚
â”œâ”€â”€ ranking/                 æ’åèˆ‡æ¨è–¦ç³»çµ±
â”‚   â””â”€â”€ rankingAlgorithm.js  â€¢ å¤šç¶­åº¦è©•åˆ†
â”‚                           â€¢ æ¬Šé‡è¨ˆç®—
â”‚                           â€¢ æ’åºç®—æ³•
â”‚
â”œâ”€â”€ chat/                    å³æ™‚èŠå¤©ç³»çµ±
â”‚   â””â”€â”€ chatManager.js       â€¢ æ¶ˆæ¯æ”¶ç™¼
â”‚                           â€¢ æ‰“å­—æŒ‡ç¤º
â”‚                           â€¢ æœªè®€è¨ˆæ•¸
â”‚
â”œâ”€â”€ items/                   ç‰©å“ç®¡ç†
â”‚   â””â”€â”€ itemManager.js       â€¢ CRUD æ“ä½œ
â”‚                           â€¢ å¯ç”¨æ€§ç®¡ç†
â”‚                           â€¢ ç§»äº¤æ™‚é–“
â”‚
â”œâ”€â”€ booking/                 é è¨‚ç³»çµ±
â”‚   â””â”€â”€ bookingManager.js    â€¢ é è¨‚è«‹æ±‚
â”‚                           â€¢ è¡çªæª¢æ¸¬
â”‚                           â€¢ ç‹€æ…‹ç®¡ç†
â”‚
â”œâ”€â”€ preferences/             ç”¨æˆ¶åå¥½
â”‚   â””â”€â”€ preferencesManager.js â€¢ åå¥½è¨­ç½®
â”‚                           â€¢ æ¬Šé‡é…ç½®
â”‚
â”œâ”€â”€ analytics/               åˆ†æè¿½è¹¤
â”‚   â”œâ”€â”€ analyticsLogger.js   â€¢ äº‹ä»¶è¨˜éŒ„
â”‚   â””â”€â”€ sessionRecorder.js   â€¢ æœƒè©±è¿½è¹¤
â”‚
â”œâ”€â”€ dashboard/               æ•¸æ“šå„€è¡¨æ¿
â”‚   â”œâ”€â”€ dashboardManager.js  â€¢ æ•¸æ“šå±•ç¤º
â”‚   â””â”€â”€ sessionReplay.js     â€¢ æœƒè©±é‡æ”¾
â”‚
â””â”€â”€ testing/                 æ¸¬è©¦å·¥å…·
    â”œâ”€â”€ automatedTest.js     â€¢ è‡ªå‹•åŒ–æ¸¬è©¦
    â”œâ”€â”€ testDataGenerator.js â€¢ è³‡æ–™ç”Ÿæˆ
    â””â”€â”€ dataCleaner.js       â€¢ è³‡æ–™æ¸…ç†
```

#### 3B. UI æ¨¡çµ„ (`src/ui/`)
```
src/ui/
â”œâ”€â”€ viewManager.js           è¦–åœ–åˆ‡æ›ç®¡ç†
â”œâ”€â”€ itemRenderer.js          ç‰©å“åˆ—è¡¨æ¸²æŸ“
â”œâ”€â”€ chatRenderer.js          èŠå¤©åˆ—è¡¨æ¸²æŸ“
â””â”€â”€ modalManager.js          Modal æ§åˆ¶
```

### ç¬¬ 4 å±¤: æœå‹™å±¤ (Service Layer)
**ä½ç½®**: `src/services/`
**è·è²¬**: å°è£å¤–éƒ¨æœå‹™èª¿ç”¨

```javascript
// src/services/firebaseService.js
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Firebase Service (Singleton) â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ å°è£ Firebase SDK          â”‚
â”‚  â€¢ çµ±ä¸€æ•¸æ“šåº«æ“ä½œ             â”‚
â”‚  â€¢ çµ±ä¸€èªè­‰æ“ä½œ               â”‚
â”‚  â€¢ éŒ¯èª¤è™•ç†                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç¬¬ 5 å±¤: ç‹€æ…‹ç®¡ç†å±¤ (State Management)
**ä½ç½®**: `src/stores/`
**è·è²¬**: é›†ä¸­å¼ç‹€æ…‹å­˜å„²

```javascript
// src/stores/stateStore.js
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  State Store (Singleton)    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  State:                     â”‚
â”‚  â€¢ currentUser              â”‚
â”‚  â€¢ currentChatId            â”‚
â”‚  â€¢ currentItemId            â”‚
â”‚  â€¢ userPreferences          â”‚
â”‚  â€¢ session data             â”‚
â”‚  â€¢ dashboard data           â”‚
â”‚                             â”‚
â”‚  Methods:                   â”‚
â”‚  â€¢ subscribe(key, callback) â”‚
â”‚  â€¢ setState(key, value)     â”‚
â”‚  â€¢ getState(key)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

// src/stores/cacheStore.js
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Cache Store (Singleton)    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Cache:                     â”‚
â”‚  â€¢ rankingIndex {}          â”‚
â”‚  â€¢ items Map                â”‚
â”‚  â€¢ chats Map                â”‚
â”‚                             â”‚
â”‚  Methods:                   â”‚
â”‚  â€¢ getRankingIndex()        â”‚
â”‚  â€¢ setItem(id, data)        â”‚
â”‚  â€¢ clearAll()               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç¬¬ 6 å±¤: å·¥å…·å±¤ (Utility Layer)
**ä½ç½®**: `src/utils/`
**è·è²¬**: é€šç”¨å·¥å…·å‡½æ•¸

```
src/utils/
â”œâ”€â”€ constants.js        å¸¸é‡å®šç¾©ï¼ˆEmoji, ç‹€æ…‹ç­‰ï¼‰
â”œâ”€â”€ formatters.js       æ ¼å¼åŒ–å‡½æ•¸ï¼ˆåƒ¹æ ¼ã€æ™‚é–“ç­‰ï¼‰
â””â”€â”€ validators.js       é©—è­‰å‡½æ•¸ï¼ˆæ—¥æœŸã€å¯ç”¨æ€§ç­‰ï¼‰
```

### ç¬¬ 7 å±¤: æ•¸æ“šå±¤ (Data Layer)
**ä½ç½®**: Firebase Firestore
**è·è²¬**: æ•¸æ“šæŒä¹…åŒ–

```
Firestore Collections:
â”œâ”€â”€ items               ç‰©å“é›†åˆ
â”œâ”€â”€ chats               èŠå¤©é›†åˆ
â”‚   â””â”€â”€ [chatId]/messages  æ¶ˆæ¯å­é›†åˆ
â”œâ”€â”€ bookings            é è¨‚é›†åˆ
â”œâ”€â”€ bookingLocks        é è¨‚é–é›†åˆ
â”œâ”€â”€ users               ç”¨æˆ¶é›†åˆ
â”‚   â””â”€â”€ [uid]/preferences  åå¥½å­é›†åˆ
â”œâ”€â”€ analytics           åˆ†æäº‹ä»¶é›†åˆ
â””â”€â”€ sessions            æœƒè©±é›†åˆ
    â””â”€â”€ [sessionId]/events äº‹ä»¶å­é›†åˆ
```

---

## ğŸ”„ æ•¸æ“šæµ (Data Flow)

### å…¸å‹æ“ä½œæµç¨‹: æœå°‹ç‰©å“

```
User Input (æœå°‹æ¡†)
    â†“
[HTML] onChange event
    â†“
[app.js] searchItems()
    â†“
[firebaseService] getDocs('items')
    â†“
[Firestore] è¿”å›ç‰©å“è³‡æ–™
    â†“
[rankingAlgorithm] rankItems(items, query)
    â†“ (ä½¿ç”¨ userPreferences from store)
[stateStore] getUserPreferences()
    â†“
[rankingAlgorithm] è¿”å›æ’åºå¾Œçš„ç‰©å“
    â†“
[itemRenderer] renderItems(rankedItems)
    â†“
[cacheStore] setRankingIndex(items)
    â†“
[HTML] æ›´æ–° DOM é¡¯ç¤ºç‰©å“
```

### å…¸å‹æ“ä½œæµç¨‹: æäº¤é è¨‚

```
User Action (é»æ“Šé è¨‚æŒ‰éˆ•)
    â†“
[HTML] onClick â†’ openBookingModal(itemId)
    â†“
[bookingManager] openBookingModal()
    â†“
[HTML] ç”¨æˆ¶å¡«å¯«æ—¥æœŸ
    â†“
[HTML] onSubmit â†’ submitBookingRequest()
    â†“
[bookingManager] submitBookingRequest()
    â†“ (1) é©—è­‰æ—¥æœŸ
[validators] validateBookingDates()
    â†“ (2) é©—è­‰å¯ç”¨æ€§
[validators] validateAvailability(item, dates)
    â†“ (3) æª¢æŸ¥è¡çª
[validators] buildLockIds()
    â†“
[firebaseService] getDocs(bookingLocks)
    â†“ (4) å‰µå»ºé è¨‚
[firebaseService] batch.set(booking)
[firebaseService] batch.set(locks)
    â†“
[firebaseService] batch.commit()
    â†“ (5) è¨˜éŒ„åˆ†æ
[analyticsLogger] logAnalytics('booking_attempt')
    â†“
[HTML] é¡¯ç¤ºæˆåŠŸæ¶ˆæ¯
```

### ç‹€æ…‹æ›´æ–°æµç¨‹: ç”¨æˆ¶åå¥½è®Šæ›´

```
User Action (èª¿æ•´åå¥½æ»‘æ¡¿)
    â†“
[HTML] onInput â†’ updatePreferencesPreview()
    â†“
[preferencesManager] updatePreferencesPreview()
    â†“ (å¯¦æ™‚æ›´æ–° UI)
[HTML] é¡¯ç¤ºæ¬Šé‡æè¿°
    â†“
User Action (ä¿å­˜åå¥½)
    â†“
[HTML] onSubmit â†’ savePreferences()
    â†“
[preferencesManager] savePreferences()
    â†“
[firebaseService] setDoc(preferences)
    â†“
[stateStore] setUserPreferences(newPrefs)
    â†“ (è§¸ç™¼é‡æ–°æ’å)
[itemManager] loadItems()
    â†“
[rankingAlgorithm] rankItems() (ä½¿ç”¨æ–°åå¥½)
    â†“
[itemRenderer] renderItems()
    â†“
[HTML] æ›´æ–°é¡¯ç¤ºï¼ˆç‰©å“é †åºæ”¹è®Šï¼‰
```

---

## ğŸ”— æ¨¡çµ„ä¾è³´åœ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          app.js                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                                              â”‚
         â†“                                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  firebaseService â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚   stateStore     â”‚
â”‚                  â”‚                          â”‚                  â”‚
â”‚  (Singleton)     â”‚                          â”‚  (Singleton)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†‘                                              â†‘
         â”‚                                              â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”         â”‚
    â”‚         â”‚    â”‚    â”‚    â”‚    â”‚    â”‚    â”‚         â”‚
    â†“         â†“    â†“    â†“    â†“    â†“    â†“    â†“         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”â”‚
â”‚  auth  â”‚ â”‚chatâ”‚â”‚itemsâ”‚â”‚bookâ”‚â”‚prefâ”‚â”‚analâ”‚â”‚dashâ”‚â”‚testâ”‚â”‚
â”‚ Managerâ”‚ â”‚Mgr â”‚â”‚Mgr  â”‚â”‚Mgr â”‚â”‚Mgr â”‚â”‚yticsâ”‚â”‚brd â”‚â”‚ing â”‚â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”˜â”‚
                     â”‚    â”‚                            â”‚
                     â†“    â†“                            â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
              â”‚  ranking     â”‚                        â”‚
              â”‚  Algorithm   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†‘
                     â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                       â”‚
         â†“                       â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ utils/  â”‚           â”‚   ui/    â”‚
    â”‚ â€¢ const â”‚           â”‚ â€¢ view   â”‚
    â”‚ â€¢ formatâ”‚           â”‚ â€¢ render â”‚
    â”‚ â€¢ valid â”‚           â”‚ â€¢ modal  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¾è³´èªªæ˜**:
- `â†’` è¡¨ç¤ºç›´æ¥ä¾è³´
- æ‰€æœ‰æ¥­å‹™æ¨¡çµ„éƒ½ä¾è³´ `firebaseService` å’Œ `stateStore`
- `rankingAlgorithm` æ˜¯ç¨ç«‹æ¨¡çµ„ï¼Œåƒ…ä¾è³´ `stateStore` å’Œ `utils`
- `ui` æ¨¡çµ„ä¾è³´ `utils` å’Œ `ranking` (ç”¨æ–¼æ¸²æŸ“åŒ¹é…åˆ†æ•¸)

---

## ğŸ¯ è¨­è¨ˆæ¨¡å¼

### 1. Singleton Pattern (å–®ä¾‹æ¨¡å¼)
**æ‡‰ç”¨**: `firebaseService`, `stateStore`, `cacheStore`

```javascript
// ç¢ºä¿å…¨å±€åªæœ‰ä¸€å€‹å¯¦ä¾‹
class StateStore { /* ... */ }
export const store = new StateStore(); // å°å‡ºå–®ä¾‹
```

**å„ªé»**:
- å…¨å±€ç‹€æ…‹çµ±ä¸€ç®¡ç†
- é¿å…é‡è¤‡åˆå§‹åŒ– Firebase
- ä¿è­‰æ•¸æ“šä¸€è‡´æ€§

### 2. Module Pattern (æ¨¡çµ„æ¨¡å¼)
**æ‡‰ç”¨**: æ‰€æœ‰ `src/modules/*` æ¨¡çµ„

```javascript
// æ¯å€‹æ¨¡çµ„å°è£ç›¸é—œåŠŸèƒ½
export function loadItems() { /* ... */ }
export function createListing() { /* ... */ }
// å…§éƒ¨è®Šé‡ä¸æš´éœ²
```

**å„ªé»**:
- å°è£æ€§å¥½
- é¿å…å…¨å±€æ±¡æŸ“
- æ˜“æ–¼æ¸¬è©¦

### 3. Observer Pattern (è§€å¯Ÿè€…æ¨¡å¼)
**æ‡‰ç”¨**: `stateStore` çš„è¨‚é–±æ©Ÿåˆ¶

```javascript
// è¨‚é–±ç‹€æ…‹è®ŠåŒ–
store.subscribe('currentUser', (user) => {
    console.log('User changed:', user);
});

// ç™¼å¸ƒè®ŠåŒ–
store.setState('currentUser', newUser); // è§¸ç™¼è¨‚é–±è€…
```

**å„ªé»**:
- è§£è€¦çµ„ä»¶é–“é€šè¨Š
- éŸ¿æ‡‰å¼ç‹€æ…‹æ›´æ–°

### 4. Facade Pattern (å¤–è§€æ¨¡å¼)
**æ‡‰ç”¨**: `firebaseService` å°è£ Firebase SDK

```javascript
// ç°¡åŒ–è¤‡é›œçš„ Firebase æ“ä½œ
class FirebaseService {
    async getDoc(docRef) {
        return getDoc(docRef); // çµ±ä¸€æ¥å£
    }
}
```

**å„ªé»**:
- ç°¡åŒ–è¤‡é›œæ“ä½œ
- çµ±ä¸€éŒ¯èª¤è™•ç†
- æ˜“æ–¼æ›¿æ›åº•å±¤å¯¦ç¾

### 5. Strategy Pattern (ç­–ç•¥æ¨¡å¼)
**æ‡‰ç”¨**: æ’åæ¼”ç®—æ³•çš„å¤šç¶­åº¦è©•åˆ†

```javascript
// ä¸åŒè©•åˆ†ç­–ç•¥
const scorers = {
    searchMatch: (item, query) => { /* ... */ },
    categoryPreference: (item, prefs) => { /* ... */ },
    availabilityOverlap: (item, dates) => { /* ... */ }
};
```

**å„ªé»**:
- éˆæ´»çš„è©•åˆ†æ¬Šé‡
- æ˜“æ–¼æ·»åŠ æ–°ç¶­åº¦

---

## ğŸ” å®‰å…¨è€ƒé‡

### 1. èªè­‰é©—è­‰
```javascript
// authManager.js
setupAuthListener((user) => {
    if (user && user.email.endsWith('.edu')) {
        // åƒ…å…è¨± .edu éƒµç®±
    } else {
        window.location.href = '/login.html';
    }
});
```

### 2. æ•¸æ“šé©—è­‰
```javascript
// validators.js
export function validateBookingDates(startDate, endDate) {
    // é˜²æ­¢éå»æ—¥æœŸ
    if (startDate < today) {
        return { valid: false, message: '...' };
    }
}
```

### 3. Firestore è¦å‰‡ (éœ€é…ç½®)
```javascript
// firestore.rules (å»ºè­°)
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /items/{itemId} {
      allow read: if request.auth != null;
      allow write: if request.auth.uid == resource.data.ownerId;
    }
  }
}
```

---

## âš¡ æ€§èƒ½å„ªåŒ–

### 1. ç·©å­˜ç­–ç•¥
```javascript
// cacheStore.js
// ç·©å­˜æ’åçµæœï¼Œé¿å…é‡è¤‡è¨ˆç®—
cache.setRankingIndex(rankedItems);
```

### 2. é˜²æŠ– (Debouncing)
```javascript
// sessionRecorder.js
// æ»¾å‹•äº‹ä»¶é˜²æŠ–ï¼Œæ¸›å°‘æ—¥èªŒå¯«å…¥
let scrollDebounceTimer;
function trackScroll() {
    clearTimeout(scrollDebounceTimer);
    scrollDebounceTimer = setTimeout(() => {
        logSessionEvent('scroll', data);
    }, 500);
}
```

### 3. æ™ºèƒ½æ»¾å‹•
```javascript
// chatManager.js
// åƒ…åœ¨ç”¨æˆ¶æ¥è¿‘åº•éƒ¨æ™‚è‡ªå‹•æ»¾å‹•
if (isNearBottom) {
    scrollToBottom();
}
```

### 4. æ‰¹é‡æ“ä½œ
```javascript
// bookingManager.js
// ä½¿ç”¨ Firestore batch æ¸›å°‘ç¶²çµ¡è«‹æ±‚
const batch = writeBatch(db);
batch.set(bookingRef, bookingData);
lockIds.forEach(id => batch.set(lockRef, lockData));
await batch.commit(); // ä¸€æ¬¡æ€§æäº¤
```

---

## ğŸ“ˆ å¯æ“´å±•æ€§

### æ·»åŠ æ–°æ¨¡çµ„ç¯„ä¾‹

**å ´æ™¯**: æ·»åŠ ã€Œæ”¶è—åŠŸèƒ½ã€

```javascript
// 1. å‰µå»ºæ¨¡çµ„
// src/modules/favorites/favoritesManager.js
import { firebaseService } from '../../services/firebaseService.js';
import { store } from '../../stores/stateStore.js';

export async function addToFavorites(itemId) {
    const user = store.getCurrentUser();
    await firebaseService.setDoc(
        firebaseService.doc('users', user.uid, 'favorites', itemId),
        { itemId, createdAt: serverTimestamp() }
    );
}

export async function loadFavorites() {
    // ...
}

// 2. åœ¨ app.js ä¸­é›†æˆ
import { addToFavorites, loadFavorites } from './modules/favorites/favoritesManager.js';
window.addToFavorites = addToFavorites;

// 3. åœ¨ HTML ä¸­ä½¿ç”¨
<button onclick="addToFavorites('item123')">â¤ï¸ æ”¶è—</button>
```

---

## ğŸ§ª æ¸¬è©¦ç­–ç•¥

### å–®å…ƒæ¸¬è©¦ (å»ºè­°ä½¿ç”¨ Jest)
```javascript
// __tests__/utils/formatters.test.js
import { formatPrice } from '../../src/utils/formatters.js';

describe('formatPrice', () => {
    it('should format free items', () => {
        expect(formatPrice(0)).toBe('FREE');
    });

    it('should format paid items', () => {
        expect(formatPrice(5.5)).toBe('$5.50/day');
    });
});
```

### é›†æˆæ¸¬è©¦ (å»ºè­°ä½¿ç”¨ Playwright)
```javascript
// e2e/booking.spec.js
test('should submit booking request', async ({ page }) => {
    await page.goto('http://localhost:8000');
    await page.click('#searchBtn');
    await page.click('.item-card:first-child');
    await page.click('#bookingBtn');
    await page.fill('#bookingStartDate', '2025-12-10');
    await page.fill('#bookingEndDate', '2025-12-12');
    await page.click('#submitBooking');
    await expect(page.locator('.success-message')).toBeVisible();
});
```

---

## ğŸ“Š ç›£æ§èˆ‡æ—¥èªŒ

### åˆ†æè¿½è¹¤
```javascript
// è‡ªå‹•è¿½è¹¤çš„äº‹ä»¶
- navigation: è¦–åœ–åˆ‡æ›
- click: ç”¨æˆ¶é»æ“Š
- scroll: é é¢æ»¾å‹•
- search: æœå°‹æŸ¥è©¢
- view_item: æŸ¥çœ‹ç‰©å“
- chat_open: æ‰“é–‹èŠå¤©
- booking_attempt: é è¨‚å˜—è©¦
```

### æœƒè©±é‡æ”¾
```javascript
// è¨˜éŒ„çš„æ•¸æ“š
- äº‹ä»¶æ™‚é–“æˆ³
- äº‹ä»¶é¡å‹
- äº‹ä»¶æ•¸æ“š
- ç”¨æˆ¶è·¯å¾‘
- å¯åœ¨å„€è¡¨æ¿é‡æ”¾
```

---

## ğŸ“ æœ€ä½³å¯¦è¸

### 1. æ¨¡çµ„ç¨ç«‹æ€§
âœ… æ¯å€‹æ¨¡çµ„æ‡‰è©²èƒ½ç¨ç«‹æ¸¬è©¦
âœ… æœ€å°åŒ–æ¨¡çµ„é–“ä¾è³´
âœ… é€šé `stateStore` å…±äº«ç‹€æ…‹

### 2. éŒ¯èª¤è™•ç†
âœ… æ‰€æœ‰ async å‡½æ•¸ä½¿ç”¨ try-catch
âœ… å‹å¥½çš„ç”¨æˆ¶éŒ¯èª¤æç¤º
âœ… è©³ç´°çš„æ§åˆ¶å°æ—¥èªŒ

### 3. ä»£ç¢¼é¢¨æ ¼
âœ… ä½¿ç”¨ ES6+ èªæ³•
âœ… æ¸…æ™°çš„å‡½æ•¸å‘½å
âœ… JSDoc è¨»é‡‹
âœ… ä¸€è‡´çš„ç¸®æ’ (2 æˆ– 4 ç©ºæ ¼)

### 4. æ€§èƒ½
âœ… é¿å…ä¸å¿…è¦çš„é‡æ–°æ¸²æŸ“
âœ… ä½¿ç”¨é˜²æŠ–/ç¯€æµ
âœ… ç·©å­˜è¨ˆç®—çµæœ

---

## ğŸ”® æœªä¾†å±•æœ›

### Phase 1: TypeScript é·ç§»
- æ·»åŠ é¡å‹å®šç¾©
- æ›´å¥½çš„ IDE æ”¯æŒ
- æ¸›å°‘é‹è¡Œæ™‚éŒ¯èª¤

### Phase 2: æ‰“åŒ…å„ªåŒ–
- ä½¿ç”¨ Vite æ‰“åŒ…
- ä»£ç¢¼åˆ†å‰²
- Tree shaking

### Phase 3: PWA åŠŸèƒ½
- Service Worker
- é›¢ç·šæ”¯æŒ
- æ¨é€é€šçŸ¥

### Phase 4: è‡ªå‹•åŒ–æ¸¬è©¦
- å–®å…ƒæ¸¬è©¦è¦†è“‹
- E2E æ¸¬è©¦
- CI/CD æµç¨‹

---

**æ–‡æª”ç‰ˆæœ¬**: 1.0
**æœ€å¾Œæ›´æ–°**: 2025-12-06
**ç¶­è­·è€…**: CShare Team
